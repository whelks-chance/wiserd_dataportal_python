{% extends "base.html" %}
{% load staticfiles %}

{% block content %}
    <script>
        $(document).ready(function () {
            var wkt = '';

            var res_table = $('#res_table').DataTable({
                serverSide: false,
                processing: true,
                ajax: {
                    url: '/spatial_search',
                    type: 'POST',
                    data: function ( d ) {
                        d.geography = wkt;
                        d.start = 0;
                        d.limit = 15;
                        d.type = "Qual";
                        d.test = "yes";
                    }

                },
                columns: [
                    { data: "survey_short_title" },
                    { data: "date" },
                    { data: "survey_id" },
                    { data: "area" },
                    {
                        "targets": -1,
                        "data": null,
                        "defaultContent": "<div class='btn btn-info show_questions'>Q's</div>"
                    }
                ]
            });

            function attach_question_buttons() {
                $('#res_table').find('tbody').on('click', '.show_questions', function () {
                    var data = res_table.row($(this).parents('tr')).data();
                    var questions = '<to be added here>';
                    alert(data['survey_id'] + " questions are " + questions);
                });
            }
            attach_question_buttons();

            var map_height = window.innerHeight;
            var header_height = $('#navbar_lv_header').height();

            $('#map').css({height: map_height - header_height});

            var map = L.map('map').setView([51.53181, -3.24687], 10);

            L.tileLayer('http://i7.cscloud.cf.ac.uk/osmcarto/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
                maxZoom: 15,
                id: 'your.mapbox.project.id',
                accessToken: 'your.mapbox.public.access.token'
            }).addTo(map);

            function onMapClick(e) {
                var popup = L.marker()
                        .setLatLng(e.latlng)
                        .setContent(e.latlng)
                        .openOn(map);
            }

            map.on('click', onMapClick);

            var featureGroup = L.featureGroup().addTo(map);

            var drawControl = new L.Control.Draw({
                edit: {
                    featureGroup: featureGroup
                },
                draw: {
                    polygon: true,
                    polyline: false,
                    rectangle: {
                        shapeOptions : {
                            color : '#888888'
                        }
                    },
                    circle: true,
                    marker: false
                }
            }).addTo(map);

            map.on('draw:created', showPolygonArea);
            map.on('draw:edited', showPolygonAreaEdited);

            function convertPolygonToOS(shape_geojson){

                var new_coordinates = [];
                var new_geometry = {
                    "type": "Polygon",
                    "coordinates": [[]]
                };

                for (var a = 0; a < shape_geojson['geometry']['coordinates'][0].length; a++) {
                    var ll2 = new LatLng(shape_geojson['geometry']['coordinates'][0][a][1],
                            shape_geojson['geometry']['coordinates'][0][a][0]);
                    var os2 = ll2.toOSRef();
                    {#                    var coords = os2.toString().replace('(', '').replace(')', '').split(',');#}
                    new_coordinates.push([os2.easting, os2.northing]);
                }

                new_geometry['coordinates'] = [new_coordinates];

                return new_geometry

            }
            function showPolygonAreaEdited(e) {
                e.layers.eachLayer(function(layer) {
                    showPolygonArea({ layer: layer });
                });
            }

            dialog = $( "#dialog-form" ).dialog({
                autoOpen: false,
                height: window.innerHeight - 20,
                width: window.innerWidth - 20,
                modal: true,
                buttons: {
                    Close: function() {
                        dialog.dialog( "close" );
                    }
                },
                close: function() {
                    {#                    form[ 0 ].reset();#}
                    {#                    allFields.removeClass( "ui-state-error" );#}
                }
            });
            function show_res_dialog() {
                dialog.dialog("open");
                res_table.ajax.reload();
            }

            function showPolygonArea(e) {
                featureGroup.clearLayers();
                featureGroup.addLayer(e.layer);
                e.layer.bindPopup((LGeo.area(e.layer) / 1000000).toFixed(2) + ' km<sup>2</sup>');
                e.layer.openPopup();

                {#                try {#}

                var shape_geojson = e.layer.toGeoJSON();
                var new_geojson = convertPolygonToOS(shape_geojson);
                wkt = $.geo.WKT.stringify(new_geojson);

                show_res_dialog();


                {#                    $.ajax({#}
                {#                        type: "POST",#}
                {#                    url: "http://localhost/geoportal2/index.php?r=SpatialData/SpatialSearch",#}
                {#                        url: "/spatial_search",#}
                {#                        data: {#}
                {#                            geography: wkt,#}
                {#                            start: 0,#}
                {#                            limit: 15,#}
                {#                            type: "Qual"#}
                {#                        },#}
                {#                        success: function(data) {#}
                {#                                        alert(data);#}
                {#                            $('#res_table').DataTable({data: data['surveys']});#}
                {##}
                {#                        },#}
                {#                        error: function(xhr, textStatus, errorThrown) {#}
                {#                            console.log("Problem with category: "+errorThrown+xhr.status+xhr.responseText);#}
                {#                        }#}
                {#                    });#}

                {#                } catch(e){}#}

            }
        });



    </script>

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

    <link href='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' rel='stylesheet' />
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-geodesy/v0.1.0/leaflet-geodesy.js'></script>
    <script src="http://code.jquerygeo.com/jquery.geo-1.0.0-b2.min.js"></script>

    <script type="text/javascript" src="{% static 'jscoord-1.1.1.js' %}"></script>

    {#    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.js'></script>#}
    {#    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.css' rel='stylesheet' />#}

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.css">

    <!-- DataTables -->
    <script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.js"></script>


    <div id="map" style="height: 180px;"></div>


    <div id="dialog-form" title="Surveys available for this area">
        {#        <p class="validateTips">All form fields are required.</p>#}

        <form>
            <fieldset>
                <table id="res_table" class="display" style="height: 100px;">
                    <thead>
                    <tr>
                        <th>Survey Title</th>
                        <th>Date</th>
                        <th>Survey ID</th>
                        <th>Area</th>
                        <th>Options</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <th>Survey Title</th>
                        <th>Date</th>
                        <th>Survey ID</th>
                        <th>Area</th>
                        <th>Options</th>
                    </tr>
                    </tfoot>
                    <tbody>
                    {#                    Padding #}
                    <tr><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr><td></td><td></td><td></td><td></td><td></td></tr>
                    </tbody>
                </table>

                <!-- Allow form submission with keyboard without duplicating the dialog button -->
                {#      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">#}
            </fieldset>
        </form>
    </div>

{% endblock %}

